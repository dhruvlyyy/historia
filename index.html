<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Historia AI | Netlify Edition</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&family=Roboto+Mono:wght@400&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #3B82F6;
            --text-color: #E5E7EB;
            --bg-color-1: #111827;
            --bg-color-2: #1F2937;
            --card-bg: rgba(31, 41, 55, 0.85);
            --border-color: rgba(107, 114, 128, 0.3);
            --input-bg: rgba(55, 65, 81, 0.5);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: 'Poppins', sans-serif;
            color: var(--text-color);
            background: linear-gradient(135deg, var(--bg-color-1), var(--bg-color-2));
            display: flex; justify-content: center; align-items: center;
            min-height: 100vh; overflow: hidden; padding: 1rem;
        }
        .app-container {
            width: 100%; max-width: 480px; height: 95vh; max-height: 900px;
            background: var(--card-bg); backdrop-filter: blur(20px);
            border: 1px solid var(--border-color); border-radius: 24px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            display: flex; flex-direction: column; overflow: hidden;
        }
        .screen {
            display: none; flex-direction: column; align-items: center;
            padding: 2rem; text-align: center; width: 100%; height: 100%;
            animation: fadeIn 0.5s ease-in-out; overflow-y: auto;
        }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        h1, h2 { margin-bottom: 1rem; color: #fff; }
        p { font-size: 1rem; line-height: 1.6; margin-bottom: 1.5rem; opacity: 0.9; }
        
        .btn {
            background: var(--primary-color); color: #fff; border: none;
            padding: 1rem 2rem; border-radius: 50px; font-size: 1rem; font-weight: 600;
            cursor: pointer; transition: all 0.2s ease; width: 100%; max-width: 350px; margin-top: 1rem;
        }
        .btn:hover { transform: translateY(-3px); box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4); }
        .btn:disabled { background-color: #555; cursor: not-allowed; }

        .form-container { width: 100%; text-align: left; }
        .form-group { width: 100%; margin-bottom: 1.25rem; }
        .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 0.8rem 1rem; border-radius: 8px; border: 1px solid var(--border-color);
            background: var(--input-bg); color: var(--text-color); font-size: 1rem; font-family: 'Poppins', sans-serif;
        }
        .checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; }
        .checkbox-label { background: var(--input-bg); padding: 10px 15px; border-radius: 8px; cursor: pointer; display: flex; align-items: center; gap: 8px; }

        #hpi-chat-screen { padding: 1rem; justify-content: flex-end; }
        #chat-log { width: 100%; flex-grow: 1; overflow-y: auto; padding: 10px; }
        .chat-message { padding: 12px 18px; border-radius: 20px; margin-bottom: 10px; max-width: 85%; animation: messageFadeIn 0.5s ease-out forwards; }
        @keyframes messageFadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        .ai-message { background: var(--bg-color-2); align-self: flex-start; }
        .user-message { background: var(--primary-color); align-self: flex-end; }
        .loading-indicator { align-self: center; text-align: center; }
        .loading-indicator p { font-size: 1.2rem; font-weight: 500; }
        .spinner { width: 40px; height: 40px; border: 4px solid var(--border-color); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 1rem auto; }
        @keyframes spin { to { transform: rotate(360deg); } }

        #chat-input-area { padding: 1rem; display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .option-btn {
            background: var(--bg-color-2); color: var(--text-color); border: 1px solid var(--primary-color);
            padding: 10px 20px; border-radius: 20px; cursor: pointer; transition: background-color 0.2s ease;
        }
        .option-btn:hover { background: var(--primary-color); }

        .summary-content { 
            width: 100%; height: 100%; overflow-y: auto; font-family: 'Roboto Mono', monospace;
            background-color: #081428; padding: 1.5rem; border-radius: 8px; font-size: 0.9rem;
            white-space: pre-wrap; line-height: 1.6; text-align: left;
        }
        .summary-content h3 { color: var(--primary-color); margin-top: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; font-size: 1rem; }
        .summary-content strong { color: #9CA3AF; width: 100px; display: inline-block; }
    </style>
</head>
<body>

    <div class="app-container">
        <div id="welcome-screen" class="screen active">
            <h1>Historia AI</h1>
            <p>An AI-powered clinical assistant to help document your medical history accurately and confidentially.</p>
            <button class="btn next-btn" data-next="preliminary-data-screen">Begin History Taking</button>
        </div>

        <div id="preliminary-data-screen" class="screen">
            <h2>A. Preliminary Data</h2>
            <div class="form-container">
                <div class="form-group"><label for="name">Name</label><input type="text" id="name"></div>
                <div class="form-group"><label for="age">Age</label><input type="number" id="age"></div>
                <div class="form-group"><label for="sex">Sex</label><select id="sex"><option>Male</option><option>Female</option><option>Other</option></select></div>
            </div>
            <button class="btn next-btn" data-next="chief-complaint-screen">Next: Chief Complaint</button>
        </div>
        
        <div id="chief-complaint-screen" class="screen">
            <h2>B. Chief Complaint</h2>
            <div class="form-container">
                <div class="form-group"><label>What is the main reason for your visit?</label><input type="text" id="cc-symptom" placeholder="e.g., Chest Pain"></div>
                <div class="form-group"><label>How long have you had this problem?</label><input type="text" id="cc-duration" placeholder="e.g., 3 hours"></div>
            </div>
            <button id="start-hpi-btn" class="btn">Next: Analyze Complaint with AI</button>
        </div>

        <div id="hpi-chat-screen" class="screen">
            <h2>C. History of Presenting Illness (AI)</h2>
            <div id="chat-log"></div>
            <div id="chat-input-area"></div>
        </div>
        
        <div id="past-medical-history-screen" class="screen">
            <h2>D. Past Medical History</h2>
            <div class="form-container">
                <label>Please select any major illnesses you have had:</label>
                <div class="checkbox-group">
                    <label class="checkbox-label"><input type="checkbox" value="Hypertension"> Hypertension</label>
                    <label class="checkbox-label"><input type="checkbox" value="Diabetes"> Diabetes</label>
                    <label class="checkbox-label"><input type="checkbox" value="Asthma/COPD"> Asthma/COPD</label>
                </div>
            </div>
            <button class="btn next-btn" data-next="social-history-screen">Next: Social History</button>
        </div>

        <div id="social-history-screen" class="screen">
            <h2>I. Personal & Social History</h2>
            <div class="form-container">
                <div class="form-group"><label>Tobacco Use</label><select id="social-tobacco"><option>Never</option><option>Former</option><option>Current</option></select></div>
                <div class="form-group"><label>Alcohol Use</label><select id="social-alcohol"><option>Never</option><option>Rarely</option><option>Socially</option><option>Regularly</option></select></div>
            </div>
            <button class="btn" id="generate-summary-btn">Generate Final Summary</button>
        </div>
        
        <div id="loading-summary-screen" class="screen">
            <div class="loading-indicator">
                <div class="spinner"></div>
                <p>AI is analyzing and summarizing the history...</p>
            </div>
        </div>

        <div id="summary-screen" class="screen">
            <h2>L. Final Clinical Summary</h2>
            <div class="summary-content" id="summary-output"></div>
            <button class="btn" onclick="window.location.reload()">Start New Session</button>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        let appState = {
            preliminary: {},
            cc: {},
            hpiConversation: [],
            pmh: [],
            social: {}
        };
        let chatHistory = [];

        const INTERVIEW_PROMPT = `You are Historia AI, an expert clinical history-taking assistant. Your goal is to conduct a detailed History of Presenting Illness (HPI) with a patient.
        1.  Follow the OLD CARTS mnemonic (Onset, Location, Duration, Character, Associated Symptoms, Radiation, Timing, Severity) to analyze the chief complaint.
        2.  Ask **one clear question at a time**.
        3.  When suitable, provide 3-4 short, tappable options. Format your response as: "Question text [OPTION 1|OPTION 2|OPTION 3]".
        4.  Keep your tone empathetic and professional.
        5.  After you have thoroughly covered all aspects of OLD CARTS, end your turn by responding with only the text: [HPI_COMPLETE]`;

        const SUMMARY_PROMPT_TEMPLATE = (data) => `You are a senior medical doctor. Analyze the following patient data and generate a formal clinical summary.
        
        PATIENT DATA:
        - Demographics: ${data.preliminary.name}, ${data.preliminary.age}, ${data.preliminary.sex}
        - Chief Complaint: ${data.cc.symptom} for ${data.cc.duration}
        - Past Medical History: ${data.pmh.join(', ') || 'None'}
        - Social History: Tobacco: ${data.social.tobacco}, Alcohol: ${data.social.alcohol}
        - HPI Conversation Transcript:
        ${data.hpiConversation.map(item => `AI: ${item.q}\nPatient: ${item.a}`).join('\n')}

        YOUR TASK:
        1.  Write a concise, narrative "History of Presenting Illness" paragraph. Synthesize the conversation into a professional clinical note.
        2.  Based on all available information, list 3-5 "Probable Diagnoses", with the most likely first.
        
        FORMAT YOUR RESPONSE EXACTLY LIKE THIS:
        
        History of Presenting Illness:
        [Your summary paragraph here]
        
        Probable Diagnoses:
        1. [Diagnosis 1]
        2. [Diagnosis 2]
        3. [Diagnosis 3]
        `;

        const switchScreen = (screenId) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        };

        const collectFormData = () => {
            appState.preliminary.name = document.getElementById('name').value;
            appState.preliminary.age = document.getElementById('age').value;
            appState.preliminary.sex = document.getElementById('sex').value;
            appState.cc.symptom = document.getElementById('cc-symptom').value;
            appState.cc.duration = document.getElementById('cc-duration').value;
            appState.social.tobacco = document.getElementById('social-tobacco').value;
            appState.social.alcohol = document.getElementById('social-alcohol').value;
            appState.pmh = [];
            document.querySelectorAll('#past-medical-history-screen input:checked').forEach(checkbox => {
                appState.pmh.push(checkbox.value);
            });
        };

        const chatLog = document.getElementById('chat-log');
        const chatInputArea = document.getElementById('chat-input-area');

        const addMessage = (sender, text) => {
            const message = document.createElement('div');
            message.className = `chat-message ${sender}-message`;
            message.innerHTML = `<p>${text.replace(/\n/g, '<br>')}</p>`;
            chatLog.appendChild(message);
            chatLog.scrollTop = chatLog.scrollHeight;
        };
        
        const showChatLoading = (show) => {
            let indicator = document.getElementById('chat-loading');
            if (show) {
                if (!indicator) {
                    indicator = document.createElement('div');
                    indicator.id = 'chat-loading';
                    indicator.className = 'chat-message ai-message';
                    indicator.innerHTML = `<p>...</p>`;
                    chatLog.appendChild(indicator);
                }
            } else if (indicator) {
                indicator.remove();
            }
        };

        const processAiResponse = (text) => {
            if (typeof text !== 'string') {
                console.error("AI response is not a string:", text);
                addMessage('ai', "I received an unexpected response from the AI. Let's try that again.");
                chatHistory.pop(); 
                const lastUserMessage = chatHistory.pop(); 
                if(lastUserMessage) {
                    sendUserResponse(lastUserMessage.content);
                }
                return;
            }

            if (text.trim() === '[HPI_COMPLETE]') {
                addMessage('ai', "Thank you. We've completed the detailed analysis of your main complaint.");
                setTimeout(() => switchScreen('past-medical-history-screen'), 2000);
                return;
            }

            const optionRegex = /\[(.*?)\]/;
            const match = text.match(optionRegex);
            let question = text;
            let options = [];

            if (match) {
                question = text.replace(optionRegex, '').trim();
                options = match[1].split('|').map(opt => opt.trim());
            }

            addMessage('ai', question);
            chatHistory.push({ role: "assistant", content: question });

            chatInputArea.innerHTML = '';
            if (options.length > 0) {
                options.forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = 'option-btn';
                    btn.textContent = opt;
                    btn.onclick = () => sendUserResponse(opt);
                    chatInputArea.appendChild(btn);
                });
            } else {
                const input = document.createElement('input');
                input.type = 'text';
                input.placeholder = 'Type your answer...';
                input.style.cssText = 'width: 70%; padding: 10px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);';
                const sendBtn = document.createElement('button');
                sendBtn.textContent = 'Send';
                sendBtn.className = 'option-btn';
                sendBtn.onclick = () => { if (input.value) sendUserResponse(input.value); };
                input.onkeydown = (e) => { if (e.key === 'Enter') sendBtn.click(); };
                chatInputArea.appendChild(input);
                chatInputArea.appendChild(sendBtn);
                input.focus();
            }
        };

        const sendUserResponse = (text) => {
            addMessage('user', text);
            chatHistory.push({ role: "user", content: text });
            appState.hpiConversation.push({ q: chatHistory[chatHistory.length - 2]?.content || 'N/A', a: text });
            chatInputArea.innerHTML = '';
            callGenerativeApi(INTERVIEW_PROMPT, chatHistory, processAiResponse);
        };

        const callGenerativeApi = async (systemPrompt, conversationHistory, callback) => {
            showChatLoading(true);
            
            const apiUrl = '/api/groq-proxy';

            const payload = {
                messages: [
                    { role: "system", content: systemPrompt },
                    ...conversationHistory
                ],
                tool_choice: "none"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorBody = await response.text();
                    throw new Error(`API error: ${response.status} ${response.statusText}. Details: ${errorBody}`);
                }
                
                const result = await response.json();
                const choice = result.choices[0];
                let aiText = null;

                if (choice.message && choice.message.content) {
                    aiText = choice.message.content;
                } else if (choice.message && choice.message.tool_calls && choice.message.tool_calls.length > 0) {
                    try {
                        const toolArgs = JSON.parse(choice.message.tool_calls[0].function.arguments);
                        if (toolArgs.question) {
                             aiText = toolArgs.question;
                             if (toolArgs.options) {
                                aiText += ` [${toolArgs.options.join('|')}]`;
                             }
                        }
                    } catch (e) {
                         console.error("Failed to parse tool call arguments:", e);
                         throw new Error("Failed to parse tool call from AI.");
                    }
                }

                if (aiText === null) {
                    console.error("Invalid or empty response structure from AI:", result);
                    throw new Error("Invalid response structure from AI. Model did not return content or a valid tool_call.");
                }

                callback(aiText);

            } catch (error) {
                console.error("Error calling AI model:", error);
                addMessage('ai', "I'm having trouble connecting to the AI. This could be due to an invalid API key or a network issue. Please check the console (F12) for more details.");
            } finally {
                showChatLoading(false);
            }
        };

        const generateAndDisplaySummary = async () => {
            collectFormData();
            switchScreen('loading-summary-screen');
            
            const summaryPrompt = SUMMARY_PROMPT_TEMPLATE(appState);
            
            await callGenerativeApi(summaryPrompt, [], (summaryText) => {
                const summaryOutput = document.getElementById('summary-output');
                
                const hpiMatch = summaryText.match(/History of Presenting Illness:\s*([\s\S]*?)\s*Probable Diagnoses:/);
                const dxMatch = summaryText.match(/Probable Diagnoses:\s*([\s\S]*)/);

                const hpiSummary = hpiMatch ? hpiMatch[1].trim() : "Could not generate HPI summary.";
                const diagnoses = dxMatch ? dxMatch[1].trim() : "Could not generate diagnoses.";

                summaryOutput.innerHTML = `
<h3>A. Preliminary Data</h3>
<strong>Name:</strong> <span>${appState.preliminary.name || 'N/A'}</span>
<strong>Age/Sex:</strong> <span>${appState.preliminary.age || 'N/A'} / ${appState.preliminary.sex || 'N/A'}</span>

<h3>B. Chief Complaint</h3>
<span>${appState.cc.symptom || 'N/A'} for ${appState.cc.duration || 'N/A'}</span>

<h3>C. History of Presenting Illness</h3>
<p style="font-family: 'Poppins', sans-serif;">${hpiSummary}</p>

<h3>D. Past Medical History</h3>
<span>${appState.pmh.join(', ') || 'None reported'}</span>

<h3>I. Social History</h3>
<strong>Tobacco:</strong> <span>${appState.social.tobacco || 'N/A'}</span>
<strong>Alcohol:</strong> <span>${appState.social.alcohol || 'N/A'}</span>

<h3>AI-Suggested Probable Diagnoses</h3>
<pre>${diagnoses}</pre>
                `;
                switchScreen('summary-screen');
            });
        };

        document.querySelectorAll('.next-btn').forEach(btn => {
            btn.addEventListener('click', () => switchScreen(btn.dataset.next));
        });

        document.getElementById('start-hpi-btn').addEventListener('click', () => {
            collectFormData();
            switchScreen('hpi-chat-screen');
            const initialPrompt = `Start of consultation. Patient: ${appState.preliminary.name}, ${appState.preliminary.age}. Chief Complaint: ${appState.cc.symptom} for ${appState.cc.duration}.`;
            chatHistory.push({ role: "user", content: initialPrompt });
            callGenerativeApi(INTERVIEW_PROMPT, chatHistory, processAiResponse);
        });

        document.getElementById('generate-summary-btn').addEventListener('click', generateAndDisplaySummary);
    });
    </script>
</body>
</html>
